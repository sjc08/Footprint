<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Footprint</title>
    <link rel="stylesheet" href="halfmoon.min.css">
    <link rel="stylesheet" href="daterangepicker.min.css" />
    <script src="halfmoon.min.js"></script>
    <script src="jquery.min.js"></script>
    <script src="moment-with-locales.min.js"></script>
    <script src="daterangepicker.min.js"></script>
    <script src="l7.js"></script>
    <script src="coordtransform.min.js"></script>
</head>

<body>
    <div class="page-wrapper with-navbar with-sidebar">
        <nav class="navbar">
            <div class="navbar-content">
                <button class="btn btn-action" onclick="halfmoon.toggleSidebar()">
                    <i>
                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
                            <path
                                d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z" />
                        </svg>
                    </i>
                </button>
            </div>
            <a href="#" class="navbar-brand">足迹</a>
        </nav>
        <div class="sidebar">
            <div class="sidebar-menu">
                <h5 class="sidebar-title">菜单</h5>
                <div class="sidebar-divider"></div>
                <div class="sidebar-content">
                    <div class="mb-15">
                        <label for="time">时间</label>
                        <input id="time" class="form-control">
                    </div>
                    <button class="btn btn-primary mb-15" onclick="draw()">确定</button>
                    <div class="alert alert-primary mb-15">
                        找到 <span id="count">-</span> 个点
                    </div>
                </div>
            </div>
        </div>
        <div class="content-wrapper">
            <div id="map" style="height: 100%;"></div>
        </div>
    </div>
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: 'c68019763999486713f65af69b812d37'
        }
    </script>
    <script>
        const scene = new L7.Scene({
            id: 'map',
            map: new L7.GaodeMap({
                style: 'normal',
                token: '3b9a8c37d8a26809a658bb8c59ce17a4'
            }),
        });

        $(function () {
            $('#time').daterangepicker({
                locale: {
                    format: 'Y/M/D',
                    applyLabel: '应用',
                    cancelLabel: '取消'
                }
            });
        });

        function draw() {
            scene.removeAllLayer();
            scene.removeAllMarkers();
            var path = [];
            data.forEach(i => {
                var time = moment(i.Time);
                var duration = moment.duration(i.Duration);
                var position = coordtransform.wgs84togcj02(i.Longitude, i.Latitude);
                // 检查时间
                var drp = $('#time').data('daterangepicker');
                if (time.isBetween(drp.startDate, drp.endDate)) {
                    path.push(position);
                    if (duration.asMinutes() >= 30) {
                        const marker = new L7.Marker().setLnglat(position);
                        scene.addMarker(marker);
                    }
                }
            });
            // 绘制轨迹
            const layer = new L7.LineLayer({})
                .source(convert(path))
                .size(3)
                .shape('line')
                .color('#2196F3')
                .animate({
                    interval: 1,
                    duration: 5,
                    trailLength: 1.5
                });
            scene.addLayer(layer);
            $('#count').text(path.length);
        }

        function convert(coord) {
            const geoJSON = {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: coord
                        }
                    }
                ]
            };
            return geoJSON;
        }
    </script>
</body>

</html>